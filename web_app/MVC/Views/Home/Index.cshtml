@{
    ViewData["Title"] = "Home Page";
}
<div class="text-center">
    <h1 class="display-4">Welcome</h1>
    <p>Learn about <a href="https://learn.microsoft.com/aspnet/core">building Web apps with ASP.NET Core</a>.</p>
</div>
<div id="map" style="width: 100%; height: 500px;"></div>
@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDQlZlLgO2Luut0trOyN7ESj170hGUcV6Q&callback=initMap"></script>
    <script type="text/javascript">
        $(document).ready(() => {
            var connection = new signalR.HubConnectionBuilder().withAutomaticReconnect([1000, 2000, 3000, 4000, 5000]).withUrl("https://localhost:7021/LocationHub").build();
            //Functions
            function statusShow() { $("#conStatus").text(connection.state); }
            function start() {
                connection.start().then(() => {
                    $("#loading").hide();
                    statusShow();
                }).catch((err) => {
                    console.log(err);
                    setTimeout(() => start(), 2000)
                });
                statusShow();
            }
            statusShow();
            start();
            connection.onreconnecting(err => {
                $("#loading").show();
                statusShow();
            })
            connection.onreconnected(connectionId => {
                $("#loading").hide();
                statusShow();
                console.log("connectionId: " + connectionId);
            })
            connection.onclose(() => {
                $("#loading").hide();
                statusShow();
                start();
            })
            connection.on("ReceiveClientCount", (clientCount) => {
                $("#clientCount").text(clientCount);
            })
            connection.on("ReceiveName", (lokasyon) => {
                time = lokasyon.timestamp;
                //$("#nameList").append(`<li class="list-group-item"> ${lokasyon.latitude} / ${lokasyon.longitude} / ${time}</li>`);
                console.log(lokasyon);
                var lat = parseFloat(lokasyon.latitude);
                var lng = parseFloat(lokasyon.longitude);
                updateMap(lat, lng);
            })
        })
        var map;
        var marker;
        var time = new Date().toISOString();
        var infowindow;
        //update maps
        function updateMap(lat, lng) {
            var newLatLng = new google.maps.LatLng(lat, lng);
            marker.setPosition(newLatLng);
            map.panTo(newLatLng);
            var contentString = 'Konum: ' + newLatLng.toUrlValue(6) + '<br> Zaman: ' + time;
            infowindow.setContent(contentString);
            if (infowindow.getMap()) {
                infowindow.open(map, marker);
            }
        }
        //maps api
        function initMap(latData = 41.1082, lngData = 28.9784) {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: latData, lng: lngData },
                zoom: 14
            });
            marker = new google.maps.Marker({
                position: { lat: latData, lng: lngData },
                map: map,
                icon: {
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                    scale: 4,
                }, // googlenin "gezi" simgesi
                title: 'Vehicle'
            })
            infowindow = new google.maps.InfoWindow();
            marker.addListener('click', function () {
                var konum = marker.getPosition();
                infowindow.setContent('Konum: ' + konum.toUrlValue(6) + '<br> Zaman: ' + time);
                infowindow.open(map, marker);
            })
        }
    </script>
}

<div id="connectionStatus" class="row">
    <div class="col-md-8 offset-2">
        <div class="alert alert-info">
            <div class="d-flex align-items-center">
                Bağlantı Durumu: <strong id="conStatus"></strong>
                ,Client Sayısı: <strong id="clientCount"></strong>
                <div id="loading" class="spinner-border ms-auto text-primary"></div>
            </div>
            <div class="clearfix"></div>
        </div>
    </div>
    <div class="col-md-8 offset-2">
        <ul class="list-group" id="nameList"></ul>
    </div>
</div>